#!/bin/bash

# Script to organize tda and tdi files into numbered folders
# Input directory containing the files
INPUT_DIR="/eftu/entity/incoming"

# Check if input directory exists
if [ ! -d "$INPUT_DIR" ]; then
    echo "Error: Input directory $INPUT_DIR does not exist"
    exit 1
fi

# Change to the input directory
cd "$INPUT_DIR" || exit 1

echo "Starting file organization in $INPUT_DIR"
echo "----------------------------------------"

# Process all tdi and tda files (case insensitive)
for file in *.[Tt][Dd][IiAa].*; do
    # Skip if no files match the pattern
    [ ! -f "$file" ] && continue
    
    # Extract the file type (tdi or tda) and number
    if [[ $file =~ ^([Tt][Dd][IiAa])\.([0-9]+)$ ]]; then
        file_type=$(echo "${BASH_REMATCH[1]}" | tr '[:upper:]' '[:lower:]')  # Convert to lowercase
        number="${BASH_REMATCH[2]}"
        
        echo "Processing: $file -> Type: $file_type, Number: $number"
        
        # Create the numbered directory if it doesn't exist
        if [ ! -d "$number" ]; then
            mkdir -p "$number"
            echo "  Created directory: $number"
        fi
        
        # Move and rename the file
        new_filename="${file_type}.raw"
        
        if [ -f "$number/$new_filename" ]; then
            echo "  Warning: $number/$new_filename already exists, backing up as ${new_filename}.backup"
            mv "$number/$new_filename" "$number/${new_filename}.backup"
        fi
        
        mv "$file" "$number/$new_filename"
        echo "  Moved: $file -> $number/$new_filename"
        
    else
        echo "Warning: File $file doesn't match expected pattern (type.number)"
    fi
done

echo "----------------------------------------"
echo "File organization complete!"
echo ""
echo "Directory structure created:"
for dir in */; do
    if [[ $dir =~ ^[0-9]+/$ ]]; then
        echo "  $dir"
        ls -la "$dir" | grep -E "\.(raw|backup)$" | awk '{print "    " $9}'
    fi
done
